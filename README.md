# Predict-US-stocks-closing-movements

![image](https://github.com/Tony980624/Predict-US-stocks-closing-movements/blob/main/file01/header.jpg)

竞赛目标 :开发一个模型，能够使用来自股票订单簿和收盘拍卖的数据预测数百家纳斯达克上市公司股票的收盘价格走势。拍卖信息可以用来调整价格，评估供需动态，并识别交易机会。

# 取得结果

![result](https://github.com/Tony980624/Predict-US-stocks-closing-movements/blob/main/file01/Tony980%20-%20Optiver%20-%20Trading%20at%20the%20Close.png)

# 训练数据变量解读

- **stock_id** - 股票的唯一标识符。并非所有股票ID在每个时间桶中都存在。
- **date_id** - 日期的唯一标识符。日期ID在所有股票中是连续且一致的。
- **imbalance_size** - 当前参考价格下未匹配的金额（以美元计）。
- **imbalance_buy_sell_flag** - 反映拍卖不平衡方向的指标。
  - `1` 表示买方不平衡。
  - `-1` 表示卖方不平衡。
  - `0` 表示无不平衡。
- **reference_price** - 在此价格下，匹配的股份最大化，不平衡最小化，且与买卖叫价中点的距离最小化。这个价格也可以看作是最佳买价和最佳卖价之间的近似价格。
- **matched_size** - 当前参考价格下可以匹配的金额（以美元计）。
- **far_price** - 基于仅拍卖兴趣的最大化股份匹配的交叉价格。此计算不包括连续市场订单。
- **near_price** - 基于拍卖和连续市场订单的最大化股份匹配的交叉价格。
- **[bid/ask]_price** - 非拍卖账本中最具竞争力的买/卖级别的价格。
- **[bid/ask]_size** - 非拍卖账本中最具竞争力的买/卖级别的美元名义金额。
- **wap** - 非拍卖账本中的加权平均价格。
- **seconds_in_bucket** - 自当天收市拍卖开始以来经过的秒数，始终从0开始。
- **target** - 股票WAP的未来60秒移动减去合成指数的未来60秒移动。仅在训练集中提供。
- 合成指数是 Optiver 为此竞赛构建的基于纳斯达克上市股票的自定义加权指数。
- 目标值的单位是基点，这是金融市场中常用的度量单位。1基点的价格移动等同于0.01%的价格移动。
- 在当前观测时刻t，目标可以定义为：

  
![target](https://github.com/Tony980624/Predict-US-stocks-closing-movements/blob/main/file01/target.png)

All size related columns are in USD terms.

# 估算出每只股票对值数的影响权重

## 线性回归估算合成指数权重

### 数据加载和预处理
- 使用 `pandas` 读取股票数据。
- 计算每只股票在不同日期和时间桶内的回报率 (`stock_return`)。
- 从股票回报率中扣除目标值 (`target`) 得到指数回报率 (`index_return`)。

### 构建矩阵
- `stock_returns` 和 `index_returns` 初始化为零矩阵，存储每只股票在每个日期和时间桶的回报率。
- 遍历每只股票和日期的组合，计算回报率和调整后的指数回报率。

### 线性回归模型
- 使用 `LinearRegression` 来拟合数据，使模型预测的指数回报率与实际计算的指数回报率尽可能接近。
- 自变量 X 是股票的回报率，因变量 y 是指数的回报率。
- 回归模型找到的系数（权重）反映每只股票对指数影响的相对重要性。

### 模型评估
- 输出回归系数（每只股票的权重）、截距和 R² 值（决定系数，衡量模型拟合质量的指标）。
- R² 值接近 1 表示模型拟合得非常好，几乎可以完美预测指数回报率。

### 权重的实际应用
- 这些权重帮助投资者或基金经理了解哪些股票对指数波动的贡献最大，从而进行更有针对性的投资决策。

# 特这工程

通过创建新的特征或转换现有特征，特征工程能够帮助模型更好地理解数据，从而提高模型的准确性和预测能力。合适的特征可以显著提升模型对复杂数据模式的识别能力。
在某些情况下，原始数据可能包含大量的噪声或无关信息。特征工程可以通过选择和转换这些特征来去除噪声，从而简化模型的学习过程。例如，降维技术如PCA可以减少数据的维数，降低模型的复杂性。

## 特征工程总结

### 基本计算特征
- **计算组合特征**：通过计算交易尺寸和价格的组合，如买卖双方尺寸之和、买卖价格的乘积等，揭示市场的即时供需状态。
- **市场不平衡指标**：引入如买卖双方的尺寸比、价格比以及不平衡尺寸比等特征，帮助模型捕捉市场力量之间的动态平衡。

### 高级统计特征
- **价格组合操作**：对不同价格字段（如参考价、远期价、近期价等）进行组合，计算它们之间的差异、乘积和比例，尝试捕获价格之间可能存在的复杂关系。
- **使用公式计算新特征**：计算三个价格的最大值、最小值和中间值的不平衡比例，提供有关价格波动和市场状况的深入见解。

### 维度降低
- **PCA分析**：对涉及价格的所有特征进行主成分分析（PCA），旨在通过减少特征数量捕捉价格数据中的主要变动，简化模型并可能提高性能。

# 多模型Bagging,对结果求平均（投票）

训练使用了五折交叉验证（变量 N_fold 设置为5）
在每一折中，数据被分为训练集和验证集，模型在训练集上进行训练，在验证集上进行评估。
训练时使用了早停技术（early_stopping_rounds），这有助于防止过拟合，即如果在连续多次迭代中验证集的表现没有提升，则停止训练。在预测时，代码设计是使用了所有训练好的模型进行预测，然后取这些模型预测结果的平均值作为最终的预测结果。可以提升预测的稳定性和准确性
